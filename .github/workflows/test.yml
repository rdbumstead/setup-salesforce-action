name: Quick Tests

on:
  push:
    branches: [main, develop]
    paths:
      - "action.yml"
      - ".github/workflows/**"
      - "package.json"
  pull_request:
    branches: [main, develop]
    paths:
      - "action.yml"
      - ".github/workflows/**"
      - "package.json"
  workflow_dispatch:

# Cancel in-progress runs for the same PR/branch
concurrency:
  group: quick-tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-minimal:
    name: Minimal Setup (Auth)
    runs-on: ubuntu-latest
    if: github.repository_owner == 'rdbumstead' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Salesforce (Minimal)
        id: setup-sf
        uses: ./
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ vars.SFDX_USERNAME }}

      - name: Verify Basic Setup
        run: |
          echo "Testing basic SF CLI functionality..."
          sf --version
          sf org display

          echo "Verifying outputs..."
          echo "Org ID: ${{ steps.setup-sf.outputs.org_id }}"
          echo "Org Type: ${{ steps.setup-sf.outputs.org_type }}"
          echo "Org Edition: ${{ steps.setup-sf.outputs.org_edition }}"
          echo "Source Flags: ${{ steps.setup-sf.outputs.source_flags }}"

          # Verify outputs are not empty
          if [ -z "${{ steps.setup-sf.outputs.org_id }}" ]; then
            echo "‚ùå org_id output is empty"
            exit 1
          fi

          # Verify source_flags matches expectations
          if [[ "${{ steps.setup-sf.outputs.source_flags }}" != *"--source-dir force-app"* ]]; then
             echo "‚ùå source_flags output is incorrect: ${{ steps.setup-sf.outputs.source_flags }}"
             exit 1
          fi

  test-skip-auth:
    name: CLI Only (No Auth)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Salesforce (Skip Auth)
        uses: ./
        with:
          skip_auth: "true"

      - name: Verify CLI Installation
        run: |
          sf --version
          sf plugins --core

          echo "‚úÖ CLI installed successfully without authentication"

  test-custom-plugins:
    name: Custom Plugins
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup with Custom Plugin
        uses: ./
        with:
          skip_auth: "true"
          # Installing a small, real plugin to test logic
          custom_sf_plugins: "sfdx-hardis"

      - name: Verify Custom Plugin
        run: |
          if sf plugins | grep -q "sfdx-hardis"; then
            echo "‚úÖ Custom plugin installed"
          else
            echo "‚ùå Custom plugin failed to install"
            exit 1
          fi

  test-with-plugins:
    name: With Plugins
    runs-on: ubuntu-latest
    if: github.repository_owner == 'rdbumstead' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Salesforce with Plugins
        uses: ./
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ vars.SFDX_USERNAME }}
          install_scanner: "true"
          install_delta: "true"
          strict: "true"

      - name: Verify Plugins
        run: |
          echo "Checking installed plugins..."

          if sf plugins | grep -q "sfdx-git-delta"; then
            echo "‚úÖ sfdx-git-delta installed"
          else
            echo "‚ùå sfdx-git-delta not found"
            exit 1
          fi

          if sf plugins | grep -q "code-analyzer"; then
            echo "‚úÖ code-analyzer installed"
          else
            echo "‚ùå code-analyzer not found"
            exit 1
          fi

  test-dev-tools:
    name: With Dev Tools
    runs-on: ubuntu-latest
    if: github.repository_owner == 'rdbumstead' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Salesforce with Dev Tools
        uses: ./
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ vars.SFDX_USERNAME }}
          install_prettier: "true"
          install_eslint: "true"
          install_lwc_jest: "true"
          strict: "true"

      - name: Verify Dev Tools
        run: |
          echo "Checking dev tools..."

          if command -v prettier &> /dev/null; then
            prettier --version
            echo "‚úÖ Prettier installed"
          else
            echo "‚ùå Prettier not found"
            exit 1
          fi

          if command -v eslint &> /dev/null; then
            eslint --version
            echo "‚úÖ ESLint installed"
          else
            echo "‚ùå ESLint not found"
            exit 1
          fi

          if npm list -g @salesforce/sfdx-lwc-jest &> /dev/null; then
            echo "‚úÖ LWC Jest installed"
          else
            echo "‚ùå LWC Jest not found"
            exit 1
          fi

  test-custom-alias:
    name: Custom Alias & Settings
    runs-on: ubuntu-latest
    if: github.repository_owner == 'rdbumstead' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup with Custom Settings
        uses: ./
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ vars.SFDX_USERNAME }}
          alias: "CustomOrgName"
          node_version: "20"
          cli_version: "latest"

      - name: Verify Custom Alias
        run: |
          echo "Checking custom alias..."
          sf org list

          if sf org display --target-org CustomOrgName; then
            echo "‚úÖ Custom alias working"
          else
            echo "‚ùå Custom alias not found"
            exit 1
          fi

  test-error-handling:
    name: Error Handling
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test Missing Required Inputs
        id: test-missing-inputs
        continue-on-error: true
        uses: ./
        with:
          skip_auth: "false"
          # Intentionally missing jwt_key, client_id, username

      - name: Verify Error Was Caught
        run: |
          if [ "${{ steps.test-missing-inputs.outcome }}" = "failure" ]; then
            echo "‚úÖ Action correctly failed with missing inputs"
          else
            echo "‚ùå Action should have failed with missing inputs"
            exit 1
          fi

  test-cache-behavior:
    name: Cache Behavior
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: First Run (Cache Miss Expected)
        uses: ./
        with:
          skip_auth: "true"
          install_delta: "true"

      - name: Second Run (Cache Hit Expected)
        uses: ./
        with:
          skip_auth: "true"
          install_delta: "true"

      - name: Verify
        run: |
          echo "‚úÖ Cache behavior test completed"
          echo "Check action logs to verify cache hit on second run"

  test-network-retry:
    name: Network Retry Logic
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Salesforce (with retry simulation)
        id: setup-retry
        continue-on-error: true
        uses: ./
        with:
          skip_auth: "true"
          cli_version: "999.999.999" # Non-existent version to trigger retries
          strict: "false"

      - name: Verify Retry Behavior
        run: |
          # Verify that the step actually failed
          if [ "${{ steps.setup-retry.outcome }}" = "failure" ]; then
            echo "‚úÖ Network retry logic correctly failed after retries"
          else
            echo "‚ùå Action should have failed but succeeded"
            exit 1
          fi

  test-invalid-plugins:
    name: Invalid Plugin Handling
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test Invalid Plugin Names (Non-Strict)
        id: test-invalid-non-strict
        uses: ./
        with:
          skip_auth: "true"
          custom_sf_plugins: "invalid plugin name!,@invalid/scope,valid-plugin"
          strict: "false"

      - name: Test Invalid Plugin Names (Strict Mode)
        id: test-invalid-strict
        continue-on-error: true
        uses: ./
        with:
          skip_auth: "true"
          custom_sf_plugins: "invalid!name"
          strict: "true"

      - name: Verify Strict Mode Fails
        run: |
          if [ "${{ steps.test-invalid-strict.outcome }}" = "failure" ]; then
            echo "‚úÖ Strict mode correctly failed with invalid plugin name"
          else
            echo "‚ùå Strict mode should have failed with invalid plugin"
            exit 1
          fi

  test-source-flags:
    name: Source Flags Output
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Mock Directories
        run: mkdir -p force-app src packages/core

      - name: Setup with Multiple Directories
        id: setup-dirs
        uses: ./
        with:
          skip_auth: "true"
          source_dirs: "force-app,src,packages/core"

      - name: Verify Source Flags
        run: |
          echo "Source Flags: ${{ steps.setup-dirs.outputs.source_flags }}"

          # Should contain all three directories
          if [[ "${{ steps.setup-dirs.outputs.source_flags }}" != *"force-app"* ]] || \
             [[ "${{ steps.setup-dirs.outputs.source_flags }}" != *"src"* ]] || \
             [[ "${{ steps.setup-dirs.outputs.source_flags }}" != *"packages/core"* ]]; then
            echo "‚ùå source_flags missing expected directories"
            exit 1
          fi

          echo "‚úÖ source_flags output correct"

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      - test-minimal
      - test-skip-auth
      - test-custom-plugins
      - test-with-plugins
      - test-dev-tools
      - test-custom-alias
      - test-error-handling
      - test-cache-behavior
      - test-network-retry
      - test-invalid-plugins
      - test-source-flags
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## üß™ Quick Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check each test
          if [ "${{ needs.test-minimal.result }}" = "success" ]; then
            echo "‚úÖ **Minimal Setup**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-minimal.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è **Minimal Setup**: Skipped (no secrets)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Minimal Setup**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-skip-auth.result }}" = "success" ]; then
            echo "‚úÖ **CLI Only**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **CLI Only**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-custom-plugins.result }}" = "success" ]; then
            echo "‚úÖ **Custom Plugins**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Custom Plugins**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-with-plugins.result }}" = "success" ]; then
            echo "‚úÖ **With Plugins**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-with-plugins.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è **With Plugins**: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **With Plugins**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-dev-tools.result }}" = "success" ]; then
            echo "‚úÖ **Dev Tools**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-dev-tools.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è **Dev Tools**: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Dev Tools**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-custom-alias.result }}" = "success" ]; then
            echo "‚úÖ **Custom Settings**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-custom-alias.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è **Custom Settings**: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Custom Settings**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-error-handling.result }}" = "success" ]; then
            echo "‚úÖ **Error Handling**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Error Handling**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-cache-behavior.result }}" = "success" ]; then
            echo "‚úÖ **Cache Behavior**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Cache Behavior**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-network-retry.result }}" = "success" ]; then
            echo "‚úÖ **Network Retry**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Network Retry**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-invalid-plugins.result }}" = "success" ]; then
            echo "‚úÖ **Invalid Plugin Handling**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Invalid Plugin Handling**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-source-flags.result }}" = "success" ]; then
            echo "‚úÖ **Source Flags Output**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Source Flags Output**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üí° **Note**: Some tests require secrets and will be skipped in forks." >> $GITHUB_STEP_SUMMARY
          echo "For comprehensive cross-platform testing, see the \`test-cross-platform.yml\` workflow." >> $GITHUB_STEP_SUMMARY

      - name: Check Critical Tests
        run: |
          CRITICAL_FAILED=false

          if [ "${{ needs.test-skip-auth.result }}" != "success" ]; then
            echo "‚ùå Critical test failed: CLI Only"
            CRITICAL_FAILED=true
          fi

          if [ "${{ needs.test-custom-plugins.result }}" != "success" ]; then
            echo "‚ùå Critical test failed: Custom Plugins"
            CRITICAL_FAILED=true
          fi

          if [ "${{ needs.test-error-handling.result }}" != "success" ]; then
            echo "‚ùå Critical test failed: Error Handling"
            CRITICAL_FAILED=true
          fi

          if [ "${{ needs.test-cache-behavior.result }}" != "success" ]; then
            echo "‚ùå Critical test failed: Cache Behavior"
            CRITICAL_FAILED=true
          fi

          if [ "${{ needs.test-network-retry.result }}" != "success" ]; then
            echo "‚ùå Critical test failed: Network Retry"
            CRITICAL_FAILED=true
          fi

          if [ "${{ needs.test-source-flags.result }}" != "success" ]; then
            echo "‚ùå Critical test failed: Source Flags"
            CRITICAL_FAILED=true
          fi

          if [ "$CRITICAL_FAILED" = true ]; then
            echo ""
            echo "‚ùå One or more critical tests failed"
            exit 1
          fi

          echo "‚úÖ All critical tests passed"
