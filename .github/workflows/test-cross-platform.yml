# ============================================================================
# .github/workflows/test-cross-platform.yml
# Comprehensive cross-platform validation
# ============================================================================
name: "Cross-Platform Tests"

on:
  push:
    branches: [main, develop]
    paths:
      - "action.yml"
      - ".github/workflows/test-cross-platform.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "action.yml"
      - ".github/workflows/test-cross-platform.yml"
  workflow_dispatch:
    inputs:
      run_auth_tests:
        description: "Run authentication tests"
        required: false
        type: boolean
        default: false

concurrency:
  group: cross-platform-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # CLI INSTALLATION (Matrix)
  # ============================================================================
  cli-install:
    name: CLI Install - ${{ matrix.os }} (Node ${{ matrix.node }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node: ["18", "20"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Setup Salesforce (Skip Auth)
        uses: ./
        with:
          skip_auth: "true"
          node_version: ${{ matrix.node }}

      - name: Verify Installation
        shell: bash
        run: |
          sf --version
          echo "âœ… CLI installed successfully on ${{ matrix.os }}"

  # ============================================================================
  # HEALTH CHECKS
  # ============================================================================
  health-check:
    name: CLI Health Verification - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Salesforce CLI
        uses: ./
        with:
          skip_auth: "true"

      - name: Comprehensive CLI Health Check
        shell: bash
        run: |
          echo "ðŸ” Verifying CLI functionality..."
          sf --version || exit 1
          sf plugins --core || exit 1
          sf --help >/dev/null 2>&1 || exit 1
          sf config list >/dev/null 2>&1 || exit 1
          echo "âœ… All checks passed"

  # ============================================================================
  # PLATFORM-SPECIFIC BEHAVIORS
  # ============================================================================
  macos-specifics:
    name: macOS Specifics
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify timeout command absence
        run: |
          # Verify action works strategies without GNU timeout
          if command -v timeout >/dev/null 2>&1; then
            echo "âš ï¸  timeout command exists (unexpected on vanilla macOS)"
          else
            echo "âœ… No timeout command (expected on macOS)"
          fi

      - name: Setup Salesforce
        uses: ./
        with:
          skip_auth: "true"
          cli_version: "latest"

      - name: Verify Success
        run: echo "âœ… Action succeeded despite missing timeout command"

  file-permissions:
    name: File Permissions - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    if: github.repository_owner == 'rdbumstead' || (github.event_name == 'workflow_dispatch' && inputs.run_auth_tests)
    strategy:
      matrix:
        # Check permissions on Unix systems where chmod matters
        # Windows handling is different (files often readable by user)
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup with JWT Auth
        uses: ./
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ vars.SFDX_USERNAME }}

      - name: Verify Cleanup
        shell: bash
        run: |
          # Check that sensitive files were cleaned up
          FAILED=false

          if [ -f "jwt.key" ]; then
            echo "âŒ SECURITY: jwt.key file not cleaned up!"
            FAILED=true
          fi

          if [ -f "authurl.txt" ]; then
            echo "âŒ SECURITY: authurl.txt file not cleaned up!"
            FAILED=true
          fi

          if [ -f "access_token.txt" ]; then
            echo "âŒ SECURITY: access_token.txt file not cleaned up!"
            FAILED=true
          fi

          if [ "$FAILED" = "true" ]; then
            exit 1
          fi

          echo "âœ… No sensitive files left in workspace"

  source-dirs-cross-platform:
    name: Source Dirs - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Test Directories
        shell: bash
        run: |
          mkdir -p "force-app"
          mkdir -p "packages/core"
          mkdir -p "src"

      - name: Setup with Multiple Source Dirs
        id: setup
        uses: ./
        with:
          skip_auth: "true"
          source_dirs: "force-app,packages/core,src"

      - name: Verify Source Flags (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          FLAGS="${{ steps.setup.outputs.source_flags }}"

          for dir in force-app packages/core src; do
            if [[ "$FLAGS" == *"--source-dir $dir"* ]]; then
              echo "âœ… $dir found in flags"
            else
              echo "âŒ Missing $dir in flags: $FLAGS"
              exit 1
            fi
          done

      - name: Verify Source Flags (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $flags = "${{ steps.setup.outputs.source_flags }}"

          @("force-app", "packages/core", "src") | ForEach-Object {
            if ($flags -match "--source-dir $_") {
              Write-Host "âœ… $_ found in flags"
            } else {
              Write-Host "âŒ Missing $_ in flags: $flags"
              exit 1
            }
          }

  # ============================================================================
  # CACHE TESTS (Matrix)
  # ============================================================================
  cache-seed:
    name: Cache Seed - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Seed Cache (Exact Version)
        uses: ./
        with:
          skip_auth: "true"
          install_delta: "true"
          # Use exact version granularity to ensure a stable key for the verification job
          cli_version_for_cache: "exact"

  cache-verify:
    name: Cache Verify - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: cache-seed
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore Cache (Exact Version)
        id: setup
        uses: ./
        with:
          skip_auth: "true"
          install_delta: "true"
          cli_version_for_cache: "exact"

      - name: Verify Execution
        shell: bash
        run: |
          echo "âœ… Action completed successfully (cache restoration implicit)"
          echo "See logs above for 'Cache restored from key' message."

  # ============================================================================
  # SUMMARY
  # ============================================================================
  summary:
    name: Cross-Platform Summary
    runs-on: ubuntu-latest
    needs:
      - cli-install
      - health-check
      - macos-specifics
      - source-dirs-cross-platform
      - cache-verify
      - file-permissions
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸŒ Cross-Platform Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.cli-install.result }}" = "success" ]; then
            echo "âœ… **CLI Install**: Passed (All OS/Node)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **CLI Install**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.health-check.result }}" = "success" ]; then
            echo "âœ… **Health Check**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Health Check**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.macos-specifics.result }}" = "success" ]; then
            echo "âœ… **macOS Specifics**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **macOS Specifics**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.source-dirs-cross-platform.result }}" = "success" ]; then
            echo "âœ… **Source Dirs**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Source Dirs**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.file-permissions.result }}" = "success" ]; then
            echo "âœ… **File Permissions**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.file-permissions.result }}" = "skipped" ]; then
             echo "â­ï¸ **File Permissions**: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **File Permissions**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.cache-verify.result }}" = "success" ]; then
            echo "âœ… **Cache Verification**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Cache Verification**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
