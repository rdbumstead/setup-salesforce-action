name: "Cross-Platform Tests"

on:
  pull_request:
    paths:
      - "action.yml"
      - ".github/workflows/**"
      - "package.json"

  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      run_auth_tests:
        description: "Run authentication tests (requires secrets)"
        required: false
        type: boolean
        default: false

jobs:
  test-cli-install:
    name: CLI Install - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: ["18", "20"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Salesforce CLI
        uses: ./
        with:
          skip_auth: "true"
          node_version: ${{ matrix.node-version }}

      - name: Verify CLI Installation (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          sf --version
          sf plugins --core

      - name: Verify CLI Installation (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          sf --version
          sf plugins --core

  test-full-setup:
    name: Full Setup - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Salesforce with Tools
        uses: ./
        with:
          skip_auth: "true"
          install_delta: "true"
          install_scanner: "true"
          install_prettier: "true"
          install_eslint: "true"
          install_lwc_jest: "true"
          strict: "true"

      - name: Verify Tool Installations (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          echo "Verifying Salesforce CLI..."
          sf --version

          echo "Verifying sfdx-git-delta..."
          sf plugins | grep sfdx-git-delta

          echo "Verifying Code Analyzer..."
          sf plugins | grep code-analyzer

          echo "Verifying Prettier..."
          prettier --version

          echo "Verifying ESLint..."
          eslint --version

          echo "‚úÖ All tools verified"

      - name: Verify Tool Installations (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Verifying Salesforce CLI..."
          sf --version

          Write-Host "Verifying sfdx-git-delta..."
          sf plugins | Select-String "sfdx-git-delta"

          Write-Host "Verifying Code Analyzer..."
          sf plugins | Select-String "code-analyzer"

          Write-Host "Verifying Prettier..."
          prettier --version

          Write-Host "Verifying ESLint..."
          eslint --version

          Write-Host "‚úÖ All tools verified"

  test-cache-first-run:
    name: Cache Test (1st Run) - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clear Cache (if exists)
        continue-on-error: true
        shell: bash
        run: |
          rm -rf ~/.npm
          rm -rf ~/.local/share/sf
          rm -rf ~/AppData/Local/sf || true
          rm -rf ~/AppData/Roaming/npm || true

      - name: Setup Salesforce (First Run)
        uses: ./
        with:
          skip_auth: "true"
          install_delta: "true"

      - name: Save Timing
        shell: bash
        run: |
          echo "first_run=true" >> $GITHUB_ENV

  test-cache-second-run:
    name: Cache Test (2nd Run) - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: test-cache-first-run
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Salesforce (Cache Hit Expected)
        uses: ./
        with:
          skip_auth: "true"
          install_delta: "true"

      - name: Verify Cache Hit
        shell: bash
        run: |
          echo "‚úÖ Second run completed (should be faster due to cache)"

  test-authentication:
    name: Auth Test - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    if: (github.event_name == 'workflow_dispatch' && inputs.run_auth_tests) || github.repository_owner == 'rdbumstead'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Salesforce with Auth
        id: setup-sf
        uses: ./
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ vars.SFDX_USERNAME }}

      - name: Verify Org Details (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          echo "Org ID: ${{ steps.setup-sf.outputs.org_id }}"
          echo "Org Type: ${{ steps.setup-sf.outputs.org_type }}"
          echo "Org Edition: ${{ steps.setup-sf.outputs.org_edition }}"

          sf org display --json

      - name: Verify Org Details (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Org ID: ${{ steps.setup-sf.outputs.org_id }}"
          Write-Host "Org Type: ${{ steps.setup-sf.outputs.org_type }}"
          Write-Host "Org Edition: ${{ steps.setup-sf.outputs.org_edition }}"

          sf org display --json

  test-error-handling:
    name: Error Handling - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test Missing Auth Inputs
        id: test-error
        continue-on-error: true
        uses: ./
        with:
          skip_auth: "false"
          # Intentionally missing jwt_key, client_id, username

      - name: Verify Error Handling (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [ "${{ steps.test-error.outcome }}" = "failure" ]; then
            echo "‚úÖ Correctly failed with missing inputs"
          else
            echo "‚ùå Should have failed with missing inputs"
            exit 1
          fi

      - name: Verify Error Handling (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if ("${{ steps.test-error.outcome }}" -eq "failure") {
            Write-Host "‚úÖ Correctly failed with missing inputs"
          } else {
            Write-Host "‚ùå Should have failed with missing inputs"
            exit 1
          }

  test-cache-performance:
    name: Cache Performance - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: test-cache-first-run
    strategy:
      matrix:
        os: [windows-latest] # Windows needs extra validation
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Salesforce (Cache Should Hit)
        id: setup-cache
        uses: ./
        with:
          skip_auth: "true"
          install_delta: "true"

      - name: Verify Cache Hit (Windows Specific)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Checking Windows cache behavior..."
          # Check if sf directory exists in AppData
          if (Test-Path "$env:USERPROFILE\AppData\Local\sf") {
            Write-Host "‚úÖ Windows cache directory exists"
          } else {
            Write-Host "‚ö†Ô∏è  Windows cache directory not found at expected location"
          }

          # Check npm cache
          if (Test-Path "$env:USERPROFILE\.npm") {
            Write-Host "‚úÖ npm cache directory exists"
          }

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      - test-cli-install
      - test-full-setup
      - test-cache-second-run
      - test-error-handling
      - test-cache-performance
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## üß™ Cross-Platform Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Test Jobs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.test-cli-install.result }}" = "success" ]; then
            echo "‚úÖ **CLI Install Tests**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **CLI Install Tests**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-full-setup.result }}" = "success" ]; then
            echo "‚úÖ **Full Setup Tests**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Full Setup Tests**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-cache-second-run.result }}" = "success" ]; then
            echo "‚úÖ **Cache Tests**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Cache Tests**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-error-handling.result }}" = "success" ]; then
            echo "‚úÖ **Error Handling Tests**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Error Handling Tests**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-cache-performance.result }}" = "success" ]; then
            echo "‚úÖ **Cache Performance Tests**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-cache-performance.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è **Cache Performance Tests**: Skipped (platform-specific)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Cache Performance Tests**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tested Platforms" >> $GITHUB_STEP_SUMMARY
          echo "- Ubuntu (Linux)" >> $GITHUB_STEP_SUMMARY
          echo "- Windows Server" >> $GITHUB_STEP_SUMMARY
          echo "- macOS" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Platform-Specific Notes" >> $GITHUB_STEP_SUMMARY
          echo "- **Windows**: Cache paths verified in AppData" >> $GITHUB_STEP_SUMMARY
          echo "- **macOS**: jq installation via Homebrew verified" >> $GITHUB_STEP_SUMMARY
          echo "- **Linux**: Default package manager (apt) used" >> $GITHUB_STEP_SUMMARY

      - name: Check Overall Status
        run: |
          FAILED=false

          if [ "${{ needs.test-cli-install.result }}" != "success" ]; then
            echo "‚ùå Required test failed: test-cli-install"
            FAILED=true
          fi

          if [ "${{ needs.test-error-handling.result }}" != "success" ]; then
            echo "‚ùå Required test failed: test-error-handling"
            FAILED=true
          fi

          if [ "${{ needs.test-full-setup.result }}" != "success" ]; then
            echo "‚ùå Required test failed: test-full-setup"
            FAILED=true
          fi

          if [ "$FAILED" = "true" ]; then
            exit 1
          fi

          if [ "${{ needs.test-cache-second-run.result }}" != "success" ]; then
            echo "‚ö†Ô∏è  Cache tests failed - performance may be impacted"
          fi

          echo "‚úÖ All required tests passed"
