# ============================================================================
# .github/workflows/test-auth.yml
# Authentication method tests (requires secrets)
# ============================================================================
name: Authentication Tests

on:
  push:
    branches: [main, develop]
    paths:
      - "action.yml"
      - ".github/workflows/test-auth.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "action.yml"
      - ".github/workflows/test-auth.yml"
  workflow_dispatch:

concurrency:
  group: auth-tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  jwt-basic:
    name: JWT - Basic Authentication
    runs-on: ubuntu-latest
    if: github.repository_owner == 'rdbumstead' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Salesforce (JWT)
        id: setup-sf
        uses: ./
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ vars.SFDX_USERNAME }}

      - name: Verify Basic Setup
        run: |
          echo "Testing basic SF CLI functionality..."
          sf --version | head -n 1
          sf org display

          echo "Verifying outputs..."
          echo "Org ID: ${{ steps.setup-sf.outputs.org_id }}"
          echo "Org Type: ${{ steps.setup-sf.outputs.org_type }}"
          echo "Org Edition: ${{ steps.setup-sf.outputs.org_edition }}"
          echo "Source Flags: ${{ steps.setup-sf.outputs.source_flags }}"

          # Verify outputs are not empty
          if [ -z "${{ steps.setup-sf.outputs.org_id }}" ]; then
            echo "‚ùå org_id output is empty"
            exit 1
          fi

          # Verify source_flags matches expectations
          if [[ "${{ steps.setup-sf.outputs.source_flags }}" != *"--source-dir force-app"* ]]; then
             echo "‚ùå source_flags output is incorrect: ${{ steps.setup-sf.outputs.source_flags }}"
             exit 1
          fi

  jwt-custom-alias:
    name: JWT - Custom Alias
    runs-on: ubuntu-latest
    if: github.repository_owner == 'rdbumstead' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup with Custom Settings
        uses: ./
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ vars.SFDX_USERNAME }}
          alias: "CustomOrgName"
          node_version: "20"
          cli_version: "latest"

      - name: Verify Custom Alias
        run: |
          echo "Checking custom alias..."
          sf org list

          if sf org display --target-org CustomOrgName; then
            echo "‚úÖ Custom alias working"
          else
            echo "‚ùå Custom alias not found"
            exit 1
          fi

  jwt-dev-hub:
    name: JWT - Dev Hub
    runs-on: ubuntu-latest
    if: github.repository_owner == 'rdbumstead' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup as Dev Hub
        uses: ./
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ vars.SFDX_USERNAME }}
          is_dev_hub: "true"

      - name: Verify Dev Hub Setting
        run: |
          DEV_HUB=$(sf config get target-dev-hub --json 2>/dev/null | jq -r 'if .result | type == "array" then .result[0].value else .result.value end // empty')

          if [ -z "$DEV_HUB" ]; then
            echo "‚ùå Dev Hub not set"
            exit 1
          fi

          if [ "$DEV_HUB" != "TargetOrg" ]; then
            echo "‚ùå Dev Hub not set correctly. Expected: TargetOrg, Got: $DEV_HUB"
            exit 1
          fi

          echo "‚úÖ Dev Hub configured successfully: $DEV_HUB"

  sfdx-url:
    name: SFDX Auth URL
    runs-on: ubuntu-latest
    if: github.repository_owner == 'rdbumstead' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup with SFDX Auth URL
        id: setup-sfdx-url
        uses: ./
        with:
          auth_method: "sfdx-url"
          sfdx_auth_url: ${{ secrets.SFDX_AUTH_URL }}

      - name: Verify SFDX URL Auth
        run: |
          echo "Testing SFDX Auth URL authentication..."

          # Clear any pre-existing default org to ensure isolation
          sf config unset target-org --global 2>/dev/null || true

          # Verify org is accessible via the default alias (TargetOrg)
          echo "üìä Checking org via default alias..."
          sf org display --target-org TargetOrg

          echo ""
          echo "Verifying outputs..."
          echo "  ‚îú‚îÄ Org ID: ${{ steps.setup-sfdx-url.outputs.org_id }}"
          echo "  ‚îú‚îÄ Auth Performed: ${{ steps.setup-sfdx-url.outputs.auth_performed }}"
          echo "  ‚îî‚îÄ API Version: ${{ steps.setup-sfdx-url.outputs.api_version }}"

          # Validate org_id is not empty
          if [ -z "${{ steps.setup-sfdx-url.outputs.org_id }}" ]; then
            echo "‚ùå org_id output is empty"
            exit 1
          fi

          # Validate auth_performed is true
          if [ "${{ steps.setup-sfdx-url.outputs.auth_performed }}" != "true" ]; then
            echo "‚ùå auth_performed should be 'true'"
            exit 1
          fi

          # Verify the org ID from sf org display matches the action output
          DISPLAYED_ORG_ID=$(sf org display --target-org TargetOrg --json | jq -r '.result.id // .result.orgId')
          if [ "$DISPLAYED_ORG_ID" != "${{ steps.setup-sfdx-url.outputs.org_id }}" ]; then
            echo "‚ùå Org ID mismatch between sf org display and action output"
            echo "  Display: $DISPLAYED_ORG_ID"
            echo "  Action: ${{ steps.setup-sfdx-url.outputs.org_id }}"
            exit 1
          fi

          echo "‚úÖ SFDX Auth URL authentication successful"

  access-token:
    name: Access Token
    runs-on: ubuntu-latest
    if: github.repository_owner == 'rdbumstead' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tools (for Minting)
        uses: ./
        with:
          skip_auth: "true"

      - name: Mint short lived access token
        id: mint-token
        shell: bash
        run: |
          echo "Authenticating via JWT to mint access token"

          sf org login jwt \
            --client-id "${{ secrets.SFDX_CLIENT_ID }}" \
            --jwt-key-file <(echo "${{ secrets.SFDX_JWT_KEY }}") \
            --username "${{ vars.SFDX_USERNAME }}" \
            --set-default \
            --alias TokenSourceOrg

          ORG_JSON=$(sf org display --target-org TokenSourceOrg --json)

          ACCESS_TOKEN=$(echo "$ORG_JSON" | jq -r '.result.accessToken')
          INSTANCE_URL=$(echo "$ORG_JSON" | jq -r '.result.instanceUrl')
          ORG_ID=$(echo "$ORG_JSON" | jq -r '.result.id')

          echo "::add-mask::$ACCESS_TOKEN"

          echo "access_token=$ACCESS_TOKEN" >> "$GITHUB_OUTPUT"
          echo "instance_url=$INSTANCE_URL" >> "$GITHUB_OUTPUT"
          echo "org_id=$ORG_ID" >> "$GITHUB_OUTPUT"

      - name: Test Action with Access Token
        id: test-action
        uses: ./
        with:
          auth_method: "access-token"
          access_token: ${{ steps.mint-token.outputs.access_token }}
          instance_url: ${{ steps.mint-token.outputs.instance_url }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          alias: "AccessTokenOrg"

      - name: Verify Access Token Authentication
        run: |
          echo "üîç Verifying access token authentication..."

          sf org display --target-org AccessTokenOrg

          echo ""
          echo "üìä Checking outputs..."
          echo "  ‚îú‚îÄ Org ID (Generator): ${{ steps.mint-token.outputs.org_id }}"
          echo "  ‚îú‚îÄ Org ID (Action): ${{ steps.test-action.outputs.org_id }}"
          echo "  ‚îú‚îÄ Username: ${{ steps.test-action.outputs.username }}"
          echo "  ‚îú‚îÄ Org Type: ${{ steps.test-action.outputs.org_type }}"
          echo "  ‚îú‚îÄ Org Edition: ${{ steps.test-action.outputs.org_edition }}"
          echo "  ‚îú‚îÄ Auth Performed: ${{ steps.test-action.outputs.auth_performed }}"
          echo "  ‚îî‚îÄ API Version: ${{ steps.test-action.outputs.api_version }}"

          # Validate outputs
          if [ -z "${{ steps.test-action.outputs.org_id }}" ]; then
            echo "‚ùå org_id output is empty"
            exit 1
          fi

          if [ "${{ steps.test-action.outputs.auth_performed }}" != "true" ]; then
            echo "‚ùå auth_performed should be 'true'"
            exit 1
          fi

          # Verify org_id matches between generator and action
          if [ "${{ steps.mint-token.outputs.org_id }}" != "${{ steps.test-action.outputs.org_id }}" ]; then
            echo "‚ùå Org IDs don't match!"
            echo "  Generator: ${{ steps.mint-token.outputs.org_id }}"
            echo "  Action: ${{ steps.test-action.outputs.org_id }}"
            exit 1
          fi

          DEFAULT_ORG=$(sf config get target-org --json 2>/dev/null | jq -r 'if .result | type == "array" then .result[0].value else .result.value end // empty')

          if [ "$DEFAULT_ORG" != "AccessTokenOrg" ]; then
            echo "‚ùå Default org not set correctly. Got: $DEFAULT_ORG"
            exit 1
          fi

          echo "‚úÖ Default org correctly set to AccessTokenOrg"
          echo ""
          echo "‚úÖ Access token authentication verified successfully"

  outputs-validation:
    name: Output Validation
    runs-on: ubuntu-latest
    if: github.repository_owner == 'rdbumstead' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Salesforce
        id: setup-sf
        uses: ./
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ vars.SFDX_USERNAME }}

      - name: Verify All Outputs
        run: |
          echo "Testing all action outputs..."

          echo "api_version: ${{ steps.setup-sf.outputs.api_version }}"
          echo "auth_performed: ${{ steps.setup-sf.outputs.auth_performed }}"
          echo "org_id: ${{ steps.setup-sf.outputs.org_id }}"
          echo "org_edition: ${{ steps.setup-sf.outputs.org_edition }}"
          echo "org_type: ${{ steps.setup-sf.outputs.org_type }}"
          echo "username: ${{ steps.setup-sf.outputs.username }}"
          echo "instance_url: ${{ steps.setup-sf.outputs.instance_url }}"
          echo "sf_cli_version: ${{ steps.setup-sf.outputs.sf_cli_version }}"
          echo "source_flags: ${{ steps.setup-sf.outputs.source_flags }}"

          # Verify api_version is not empty
          if [ -z "${{ steps.setup-sf.outputs.api_version }}" ]; then
            echo "‚ùå api_version output is empty"
            exit 1
          fi

          # Verify auth_performed is true
          if [ "${{ steps.setup-sf.outputs.auth_performed }}" != "true" ]; then
            echo "‚ùå auth_performed should be 'true'"
            exit 1
          fi

          # Verify org_type is valid
          ORG_TYPE="${{ steps.setup-sf.outputs.org_type }}"
          if [[ ! "$ORG_TYPE" =~ ^(Production|Sandbox|Scratch)$ ]]; then
            echo "‚ùå Invalid org_type: $ORG_TYPE"
            exit 1
          fi

          echo "‚úÖ All outputs validated"

  org-type-detection:
    name: Org Type Detection
    runs-on: ubuntu-latest
    if: github.repository_owner == 'rdbumstead' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Salesforce
        id: setup
        uses: ./
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ vars.SFDX_USERNAME }}

      - name: Verify Org Type Detection
        run: |
          ORG_TYPE="${{ steps.setup.outputs.org_type }}"
          INSTANCE="${{ steps.setup.outputs.instance_url }}"

          echo "Detected org type: $ORG_TYPE"
          echo "Instance URL: $INSTANCE"

          # Validate it's one of the expected values
          if [[ "$ORG_TYPE" =~ ^(Production|Sandbox|Scratch)$ ]]; then
            echo "‚úÖ Valid org type: $ORG_TYPE"
          else
            echo "‚ùå Invalid org type: $ORG_TYPE"
            exit 1
          fi

          # Additional validation based on instance URL
          if [[ "$INSTANCE" =~ (cs[0-9]+|sandbox) ]] && [ "$ORG_TYPE" = "Production" ]; then
            echo "‚ö†Ô∏è  WARNING: Possible misdetection - sandbox URL but Production type"
            echo "   This may indicate an issue with org type detection logic"
          fi

          echo "‚úÖ Org type detection validated"

  summary:
    name: Authentication Tests Summary
    runs-on: ubuntu-latest
    needs:
      - jwt-basic
      - jwt-custom-alias
      - jwt-dev-hub
      - sfdx-url
      - access-token
      - outputs-validation
      - org-type-detection
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## üîê Authentication Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.jwt-basic.result }}" = "success" ]; then
            echo "‚úÖ **JWT - Basic**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.jwt-basic.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è **JWT - Basic**: Skipped (no secrets)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **JWT - Basic**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.jwt-custom-alias.result }}" = "success" ]; then
            echo "‚úÖ **JWT - Custom Alias**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.jwt-custom-alias.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è **JWT - Custom Alias**: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **JWT - Custom Alias**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.jwt-dev-hub.result }}" = "success" ]; then
            echo "‚úÖ **JWT - Dev Hub**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.jwt-dev-hub.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è **JWT - Dev Hub**: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **JWT - Dev Hub**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.sfdx-url.result }}" = "success" ]; then
            echo "‚úÖ **SFDX Auth URL**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.sfdx-url.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è **SFDX Auth URL**: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **SFDX Auth URL**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.access-token.result }}" = "success" ]; then
            echo "‚úÖ **Access Token**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.access-token.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è **Access Token**: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Access Token**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.outputs-validation.result }}" = "success" ]; then
            echo "‚úÖ **Output Validation**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.outputs-validation.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è **Output Validation**: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Output Validation**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.org-type-detection.result }}" = "success" ]; then
            echo "‚úÖ **Org Type Detection**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.org-type-detection.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è **Org Type Detection**: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Org Type Detection**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üí° **Note**: These tests require repository secrets and will be skipped in forks." >> $GITHUB_STEP_SUMMARY
