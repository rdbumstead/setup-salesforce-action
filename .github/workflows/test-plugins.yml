# ============================================================================
# .github/workflows/test-plugins.yml
# Plugin installation and management tests
# ============================================================================
name: Plugin Tests

on:
  push:
    branches: [main, develop]
    paths:
      - "action.yml"
      - ".github/workflows/test-plugins.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "action.yml"
      - ".github/workflows/test-plugins.yml"
  workflow_dispatch:

concurrency:
  group: plugin-tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  single-plugin:
    name: Single Plugin - ${{ matrix.plugin.name }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        plugin:
          - name: "sfdx-hardis"
            verify_cmd: "sf hardis:auth:login --help"
          - name: "@dxatscale/sfpowerscripts"
            verify_cmd: "sf plugins | grep sfpowerscripts"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup with ${{ matrix.plugin.name }}
        uses: ./
        with:
          skip_auth: "true"
          custom_sf_plugins: "${{ matrix.plugin.name }}"

      - name: Verify Plugin Installation
        run: |
          echo "Verifying ${{ matrix.plugin.name }}..."
          PLUGIN="${{ matrix.plugin.name }}"

          if sf plugins --json | jq -e '.[] | select(.name == "'"$PLUGIN"'")' > /dev/null; then
            echo "âœ… $PLUGIN installed"
          else
            echo "âŒ $PLUGIN not found"
            exit 1
          fi

      - name: Test Plugin Execution
        run: |
          echo "Testing command execution..."
          ${{ matrix.plugin.verify_cmd }}
          echo "âœ… Plugin executed successfully"

  multiple-plugins:
    name: Multiple Plugins (Comma-Separated)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup with Multiple Plugins
        uses: ./
        with:
          skip_auth: "true"
          custom_sf_plugins: "sfdx-hardis"

      - name: Verify Plugins Installed
        run: |
          echo "Checking plugins installed..."

          # Verify community plugin was installed
          if sf plugins --json | jq -e '.[] | select(.name == "sfdx-hardis")' > /dev/null; then
            echo "âœ… sfdx-hardis installed"
          else
            echo "âŒ sfdx-hardis not found"
            exit 1
          fi

          # Verify bundled core plugins are present (they're always there)
          if sf plugins --json | jq -e '.[] | select(.name | test("plugin-data"))' > /dev/null; then
            echo "âœ… plugin-data present (bundled)"
          else
            echo "âŒ plugin-data not found"
            exit 1
          fi

      - name: Execute Commands
        run: |
          echo "Testing sfdx-hardis execution..."
          sf hardis:auth:login --help
          echo "âœ… sfdx-hardis command executed"

          echo ""
          echo "Testing bundled plugin-data (always present)..."
          sf data query --help
          echo "âœ… data command executed"

          echo ""
          echo "âœ… All plugins executed successfully"

  builtin-scanner:
    name: Built-in Scanner
    runs-on: ubuntu-latest
    if: github.repository_owner == 'rdbumstead' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup with Scanner
        uses: ./
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ vars.SFDX_USERNAME }}
          install_scanner: "true"
          strict: "true"

      - name: Verify Scanner Installation
        run: |
          echo "Checking Code Analyzer..."

          # Code Analyzer can appear as @salesforce/plugin-code-analyzer or code-analyzer
          if sf plugins --json | jq -e '.[] | select(.name | test("code-analyzer"))' > /dev/null; then
            echo "âœ… code-analyzer installed"
          else
            echo "âŒ code-analyzer not found"
            exit 1
          fi

  builtin-delta:
    name: Built-in Delta
    runs-on: ubuntu-latest
    if: github.repository_owner == 'rdbumstead' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup with Delta
        uses: ./
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ vars.SFDX_USERNAME }}
          install_delta: "true"
          strict: "true"

      - name: Verify Delta Installation
        run: |
          echo "Checking sfdx-git-delta..."

          if sf plugins --json | jq -e '.[] | select(.name | test("sfdx-git-delta"))' > /dev/null; then
            echo "âœ… sfdx-git-delta installed"
          else
            echo "âŒ sfdx-git-delta not found"
            exit 1
          fi

  dev-tools:
    name: Dev Tools (Prettier, ESLint, Jest)
    runs-on: ubuntu-latest
    if: github.repository_owner == 'rdbumstead' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup with Dev Tools
        uses: ./
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ vars.SFDX_USERNAME }}
          install_prettier: "true"
          install_eslint: "true"
          install_lwc_jest: "true"
          strict: "true"

      - name: Verify Dev Tools
        run: |
          echo "Checking dev tools..."

          if command -v prettier &> /dev/null; then
            prettier --version
            echo "âœ… Prettier installed"
          else
            echo "âŒ Prettier not found"
            exit 1
          fi

          if command -v eslint &> /dev/null; then
            eslint --version
            echo "âœ… ESLint installed"
          else
            echo "âŒ ESLint not found"
            exit 1
          fi

          if npm list -g @salesforce/sfdx-lwc-jest &> /dev/null; then
            echo "âœ… LWC Jest installed"
          else
            echo "âŒ LWC Jest not found"
            exit 1
          fi

  invalid-plugin-non-strict:
    name: Invalid Plugin (Non-Strict Mode)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test Invalid Plugin Names
        id: test-invalid-non-strict
        uses: ./
        with:
          skip_auth: "true"
          custom_sf_plugins: "invalid plugin name!,@invalid/scope"
          strict: "false"

      - name: Verify Action Completed
        run: |
          echo "âœ… Action completed in non-strict mode despite invalid plugin names"

  invalid-plugin-strict:
    name: Invalid Plugin (Strict Mode)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test Invalid Plugin Names (Strict)
        id: test-invalid-strict
        continue-on-error: true
        uses: ./
        with:
          skip_auth: "true"
          custom_sf_plugins: "invalid!name"
          strict: "true"

      - name: Verify Strict Mode Failed
        run: |
          if [ "${{ steps.test-invalid-strict.outcome }}" = "failure" ]; then
            echo "âœ… Strict mode correctly failed with invalid plugin name"
          else
            echo "âŒ Strict mode should have failed with invalid plugin"
            exit 1
          fi

  nonexistent-plugin-non-strict:
    name: Nonexistent Plugin (Non-Strict Mode)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test Nonexistent Plugin
        uses: ./
        with:
          skip_auth: "true"
          custom_sf_plugins: "nonexistent-plugin-xyz-123"
          strict: "false"

      - name: Verify Continued Execution
        run: |
          echo "âœ… Action continued despite nonexistent plugin in non-strict mode"

  nonexistent-plugin-strict:
    name: Nonexistent Plugin (Strict Mode)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test Nonexistent Plugin (Strict)
        id: strict-fail
        continue-on-error: true
        uses: ./
        with:
          skip_auth: "true"
          custom_sf_plugins: "nonexistent-plugin-xyz-123"
          strict: "true"

      - name: Verify Strict Mode Failed
        run: |
          if [ "${{ steps.strict-fail.outcome }}" = "failure" ]; then
            echo "âœ… Strict mode correctly failed with nonexistent plugin"
          else
            echo "âŒ Should have failed in strict mode"
            exit 1
          fi

  summary:
    name: Plugin Tests Summary
    runs-on: ubuntu-latest
    needs:
      - single-plugin
      - multiple-plugins
      - builtin-scanner
      - builtin-delta
      - dev-tools
      - invalid-plugin-non-strict
      - invalid-plugin-strict
      - nonexistent-plugin-non-strict
      - nonexistent-plugin-strict
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ”Œ Plugin Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.single-plugin.result }}" = "success" ]; then
            echo "âœ… **Single Plugin**: Passed (all 3 plugins)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Single Plugin**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.multiple-plugins.result }}" = "success" ]; then
            echo "âœ… **Multiple Plugins**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Multiple Plugins**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.builtin-scanner.result }}" = "success" ]; then
            echo "âœ… **Built-in Scanner**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.builtin-scanner.result }}" = "skipped" ]; then
            echo "â­ï¸ **Built-in Scanner**: Skipped (no secrets)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Built-in Scanner**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.builtin-delta.result }}" = "success" ]; then
            echo "âœ… **Built-in Delta**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.builtin-delta.result }}" = "skipped" ]; then
            echo "â­ï¸ **Built-in Delta**: Skipped (no secrets)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Built-in Delta**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.dev-tools.result }}" = "success" ]; then
            echo "âœ… **Dev Tools**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.dev-tools.result }}" = "skipped" ]; then
            echo "â­ï¸ **Dev Tools**: Skipped (no secrets)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Dev Tools**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.invalid-plugin-non-strict.result }}" = "success" ]; then
            echo "âœ… **Invalid Plugin (Non-Strict)**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Invalid Plugin (Non-Strict)**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.invalid-plugin-strict.result }}" = "success" ]; then
            echo "âœ… **Invalid Plugin (Strict)**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Invalid Plugin (Strict)**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.nonexistent-plugin-non-strict.result }}" = "success" ]; then
            echo "âœ… **Nonexistent Plugin (Non-Strict)**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Nonexistent Plugin (Non-Strict)**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.nonexistent-plugin-strict.result }}" = "success" ]; then
            echo "âœ… **Nonexistent Plugin (Strict)**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Nonexistent Plugin (Strict)**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Note**: Some tests require repository secrets and will be skipped in forks." >> $GITHUB_STEP_SUMMARY
